name: Run Tests and Check Coverage

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]

jobs:
    tests:
        runs-on: ubuntu-22.04

        services:
            mysql:
                image: mysql:8.0
                env:
                    MYSQL_ROOT_PASSWORD: root
                    MYSQL_USER: app
                    MYSQL_PASSWORD: app
                ports:
                    - 3306:3306
                options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

            redis:
                image: redis:7-alpine
                ports:
                    - 6379:6379

            rabbitmq:
                image: rabbitmq:3-management
                ports:
                    - 5672:5672
                env:
                    RABBITMQ_DEFAULT_USER: guest
                    RABBITMQ_DEFAULT_PASS: guest
                    RABBITMQ_NODE_IP_ADDRESS: "0.0.0.0"  # ← ОБЯЗАТЕЛЬНО

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Wait for RabbitMQ to be ready
              run: |
                  timeout 60s bash -c '
                    until nc -z 127.0.0.1 5672; do
                      echo "Waiting for RabbitMQ...";
                      sleep 2;
                    done
                  '

            - name: Set up PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.3'
                  extensions: pdo_mysql, mbstring, zip, xdebug, amqp
                  tools: composer

            - name: Create .env file
              run: |
                  echo 'APP_ENV=test' > .env
                  echo 'APP_SECRET=abc123def456' >> .env
                  echo 'DATABASE_URL="mysql://app:app@127.0.0.1:3306/app_test?serverVersion=8"' >> .env
                  echo 'DEFAULT_URI=http://localhost' >> .env
                  echo 'MESSENGER_TRANSPORT_DSN=amqp://guest:guest@127.0.0.1:5672/%2f' >> .env

            - name: Install dependencies
              run: composer install --prefer-dist --no-progress --no-suggest

            - name: Recreate test database
              run: |
                  mysql -h 127.0.0.1 -P 3306 -u root -proot -e "DROP DATABASE IF EXISTS app_test;"
                  mysql -h 127.0.0.1 -P 3306 -u root -proot -e "CREATE DATABASE app_test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
                  mysql -h 127.0.0.1 -P 3306 -u root -proot -e "GRANT ALL PRIVILEGES ON app_test.* TO 'app'@'%';"

            - name: Run migrations
              run: php bin/console doctrine:migrations:migrate --no-interaction

            - name: Run tests with coverage
              run: php bin/phpunit --coverage-clover=coverage.xml

            - name: Check code coverage ≥ 60%
              uses: codecov/codecov-action@v4
              with:
                  file: ./coverage.xml
                  fail_ci_if_coverage_less_than: 60
