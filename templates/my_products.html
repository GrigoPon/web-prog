<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Мои товары</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; }
        .form-group { margin: 10px 0; }
        input, textarea, select { width: 100%; padding: 8px; box-sizing: border-box; }
        button { background: #28a745; color: white; padding: 10px 15px; border: none; cursor: pointer; margin: 5px; }
        button.delete { background: #dc3545; }
        button.edit { background: #ffc107; color: #212529; }
        button.cancel { background: #6c757d; }
        .product { border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
        #result { margin: 15px 0; padding: 10px; background: #f8f9fa; }
        .filters { background: #f1f3f5; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        .edit-form { background: #e9ecef; padding: 10px; margin-top: 10px; display: none; }
    </style>
</head>
<body>
<h1>Мои товары</h1>

<h2>Добавить товар</h2>
<div class="form-group">
    <input type="text" id="productName" placeholder="Название товара">
</div>
<div class="form-group">
    <textarea id="productDescription" placeholder="Описание"></textarea>
</div>
<div class="form-group">
    <input type="number" id="productQuantity" placeholder="Количество" value="0">
</div>
<button onclick="addProduct()">Добавить</button>

<div id="result"></div>

<!-- Форма фильтрации -->
<div class="filters">
    <h3>Фильтрация</h3>
    <div class="form-group">
        <input type="text" id="filterName" placeholder="Название (частичное)">
    </div>
    <div class="form-group">
        <label>
            <input type="checkbox" id="filterInStock"> Только в наличии
        </label>
    </div>
    <div class="form-group">
        <input type="number" id="filterMinQty" placeholder="Мин. количество">
    </div>
    <div class="form-group">
        <input type="number" id="filterMaxQty" placeholder="Макс. количество">
    </div>
    <button onclick="applyFilters()">Применить</button>
    <button onclick="resetFilters()">Сбросить</button>
</div>

<h2>Список товаров</h2>
<div id="productsList">
    <!-- Товары будут загружены сюда -->
</div>

<script>
    const token = localStorage.getItem('token');
    if (!token) {
        alert('Вы не авторизованы! Перенаправление на главную...');
        window.location.href = '/';
    }

    // Загружаем товары при открытии (с фильтрами из URL)
    loadProductsFromUrl();

    // === ФУНКЦИИ ===
    async function fetchAndRender(url) {
        const response = await fetch(url, {
            headers: { 'X-AUTH-TOKEN': token }
        });

        const productsList = document.getElementById('productsList');
        if (response.ok) {
            const products = await response.json();
            if (products.length === 0) {
                productsList.innerHTML = '<p>Товары не найдены.</p>';
            } else {
                productsList.innerHTML = products.map(product => {
                    const quantity = product.stocks?.[0]?.quantity ?? 0;
                    return `
                        <div class="product" data-id="${product.id}">
                            <h3>${product.name}</h3>
                            <p>${product.description || ''}</p>
                            <p><strong>Количество:</strong> ${quantity}</p>
                            <button class="edit" onclick="editProduct(${product.id})">Редактировать</button>
                            <button class="delete" onclick="deleteProduct(${product.id})">Удалить</button>
                            <div id="edit-form-${product.id}" class="edit-form">
                                <div class="form-group">
                                    <input type="text" id="edit-name-${product.id}" value="${product.name}">
                                </div>
                                <div class="form-group">
                                    <textarea id="edit-description-${product.id}">${product.description || ''}</textarea>
                                </div>
                                <div class="form-group">
                                    <input type="number" id="edit-quantity-${product.id}" value="${quantity}">
                                </div>
                                <button onclick="saveProduct(${product.id})">Сохранить</button>
                                <button class="cancel" onclick="cancelEdit(${product.id})">Отмена</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        } else {
            productsList.innerHTML = '<p>Ошибка загрузки товаров.</p>';
        }
    }

    function loadProductsFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const name = urlParams.get('name');
        const inStock = urlParams.get('inStock') === 'true';
        const minQty = urlParams.get('minQuantity');
        const maxQty = urlParams.get('maxQuantity');

        // Обновляем форму
        document.getElementById('filterName').value = name || '';
        document.getElementById('filterInStock').checked = inStock;
        document.getElementById('filterMinQty').value = minQty || '';
        document.getElementById('filterMaxQty').value = maxQty || '';

        // Формируем URL для API
        const params = new URLSearchParams();
        if (name) params.set('name', name);
        if (inStock) params.set('inStock', 'true');
        if (minQty !== null) params.set('minQuantity', minQty);
        if (maxQty !== null) params.set('maxQuantity', maxQty);

        const apiUrl = `/api/products?${params.toString()}`;
        fetchAndRender(apiUrl);
    }

    function applyFilters() {
        const name = document.getElementById('filterName').value.trim() || null;
        const inStock = document.getElementById('filterInStock').checked;
        const minQty = document.getElementById('filterMinQty').value.trim();
        const maxQty = document.getElementById('filterMaxQty').value.trim();

        const params = new URLSearchParams();
        if (name) params.set('name', name);
        if (inStock) params.set('inStock', 'true');
        if (minQty !== '') params.set('minQuantity', minQty);
        if (maxQty !== '') params.set('maxQuantity', maxQty);

        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.pushState({}, '', newUrl);

        const apiUrl = `/api/products?${params.toString()}`;
        fetchAndRender(apiUrl);
    }

    function resetFilters() {
        document.getElementById('filterName').value = '';
        document.getElementById('filterInStock').checked = false;
        document.getElementById('filterMinQty').value = '';
        document.getElementById('filterMaxQty').value = '';

        const newUrl = window.location.pathname;
        window.history.pushState({}, '', newUrl);

        fetchAndRender('/api/products');
    }

    function editProduct(id) {
        document.getElementById(`edit-form-${id}`).style.display = 'block';
    }

    function cancelEdit(id) {
        document.getElementById(`edit-form-${id}`).style.display = 'none';
    }

    async function saveProduct(id) {
        const name = document.getElementById(`edit-name-${id}`).value;
        const description = document.getElementById(`edit-description-${id}`).value;
        const quantity = parseInt(document.getElementById(`edit-quantity-${id}`).value) || 0;

        const response = await fetch(`/api/products/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-AUTH-TOKEN': token
            },
            body: JSON.stringify({ name, description, quantity })
        });

        const result = document.getElementById('result');
        if (response.ok) {
            result.innerHTML = '✅ Товар обновлён!';
            cancelEdit(id);
            // Обновляем список с текущими фильтрами
            const currentUrl = new URL(window.location);
            fetchAndRender(`/api/products?${currentUrl.searchParams.toString()}`);
        } else {
            const error = await response.json();
            result.innerHTML = `❌ Ошибка: ${error.error || 'Неизвестная ошибка'}`;
        }
    }

    async function addProduct() {
        const name = document.getElementById('productName').value;
        const description = document.getElementById('productDescription').value;
        const quantity = parseInt(document.getElementById('productQuantity').value) || 0;

        const response = await fetch('/api/products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-AUTH-TOKEN': token
            },
            body: JSON.stringify({ name, description, quantity })
        });

        const result = document.getElementById('result');
        if (response.ok) {
            result.innerHTML = '✅ Товар добавлен!';
            document.getElementById('productName').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productQuantity').value = '0';
            // Обновляем список с текущими фильтрами
            const currentUrl = new URL(window.location);
            fetchAndRender(`/api/products?${currentUrl.searchParams.toString()}`);
        } else {
            const error = await response.json();
            result.innerHTML = `❌ Ошибка: ${error.error || 'Неизвестная ошибка'}`;
        }
    }

    async function deleteProduct(productId) {
        if (!confirm('Удалить товар?')) return;

        const response = await fetch(`/api/products/${productId}`, {
            method: 'DELETE',
            headers: { 'X-AUTH-TOKEN': token }
        });

        if (response.ok) {
            const currentUrl = new URL(window.location);
            fetchAndRender(`/api/products?${currentUrl.searchParams.toString()}`);
        } else {
            alert('Ошибка удаления');
        }
    }

    // Поддержка кнопки "Назад" в браузере
    window.addEventListener('popstate', () => {
        loadProductsFromUrl();
    });
</script>
</body>
</html>
